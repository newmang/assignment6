<!DOCTYPE html>
<html>
  <head>
    <script>
    // Module Name: scores.html
    // Elijah Newman-Gomez
    // Assignment X
    // CSE 594
    //
    // Description:
    // This page acts as the start screen and the end-game screen for Newmang Squares.
    // In either case, it will display the top scores of the user's Facebook friends.
    // It will also show the user's personal best high score.
    //
    // If there is a score in the window.localStorage key labeled "myScore", then it
    // is displayed as the last game's score.
    //
    // If the "myScore" value is higher than the user's current high score on Facebook,
    // then their high score on Facebook gets updated and the user has the option to
    // post their new high score to their Facebook wall as well.
    //
    // The bottom of this page has the main menu buttons for Newmang Squares.
    </script>

    <title>Newmang Blocks</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link href="style.css" rel="stylesheet" type="text/css" />
  </head>

<body style="background-color: #ffffff;">

  <div id="fb-root"></div>

  <div id="highscores"></div>

  <div style="position: absolute; bottom: 0; width: 100%; overflow: hidden;">
    <center>
    <a class="blueButton" href="tetris.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">New Game</span></a>
    <a class="blueButton" href="controls.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">Controls</span></a>
    <a class="blueButton" href="credits.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">Credits</span></a>
    </center>
  </div>

  <!-- cordova -->
  <script src="phonegap.js"></script>
  <!-- cordova facebook plugin -->
  <script src="cdv-plugin-fb-connect.js"></script>
  <!-- facebook js sdk -->
  <script src="facebook-js-sdk.js"></script>
        
<script>

function GameManager() {
  this.scoreSubmitted = null;
  this.scoreShared = null;
  this.todaysBest = null;
  this.currentScore = null;
  this.currentLines = null;
  this.currentLevel = null;

  this.player = null;
  this.playerScore = null;
  this.highScores = null;

  this.busy = 0;

  this.templates = new Array();

  this.templates["highscores_nofb"] = '\
    <font class="header">Top Scores</font>\
    <table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">\
      <tr>\
        <td align="center" style="font-size: 20px; font-family: arial, sans-serif;">\
          <a class="greenButton" href="javascript:gMyGameManager.loginFB();" style="float: left;"><span class="greenButtonText" style="font-size: 32px;">Login</span></a> with Facebook to access the leaderboards.\
        </td>\
      </tr>\
    </table>\
    <br />\
  ';

  this.templates["highscores_fb_prefix"] = '\
    <font class="header">Top Scores</font><a class="grayButton" href="javascript:gMyGameManager.logoutFB();" style="float: right;"><span class="grayButtonText" style="font-size: 18px;">Logout</span></a>\
    <div style="width: 100%; max-height: 162px; background-color: #ffffff; overflow-x: hidden; overflow-y: auto;">\
  ';

  this.templates["highscores_fb"] = '\
    <table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">\
    <tr>\
      <td align="center" valign="middle" style="background-color: #ffffff; width: 1px;">\
        <font class="label">$1</font>\
      </td>\
      <td style="width: 50px; margin-bottom: 0;">\
        <img src="http://graph.facebook.com/$2/picture?type=square" style="width: 50px; display: block;" />\
        </td>\
        <td valign="top" width="1">\
          <div style="position: relative; width: 0; height: 0;">\
            <font class="name" style="position: absolute;"><nobr>$3</nobr></font>\
          </div>\
        </td>\
        <td valign="bottom" align="right">\
          <font class="score">$4</font>\
        </td>\
      </tr>\
    </table>\
  ';

  this.templates["highscores_fb_postfix"] = '\
    </div>\
    <br />\
  ';

  this.templates["todaysbest"] = '\
    <font class="header">Today\'s Best</font>\
    <table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">\
      <tr>\
        <td>\
          <font class="score">$1</font>\
        </td>\
      </tr>\
    </table>\
    <br />\
  ';

  this.templates["yourbest"] = '\
    <font class="header">Your Best</font>\
    <table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">\
      <tr>\
        <td style="width: 50px; margin-bottom: 0;">\
          <img src="http://graph.facebook.com/$1/picture?type=square" style="width: 50px; display: block;" />\
        </td>\
        <td valign="top" width="1">\
          <div style="position: relative; width: 0; height: 0;">\
            <font class="name" style="position: absolute;"><nobr>$2</nobr></font>\
          </div>\
        </td>\
        <td valign="bottom" align="right">\
          <font class="score">$3</font>\
        </td>\
      </tr>\
    </table>\
    <br />\
  ';

  this.templates["lastgame"] = '\
    <font class="header">Last Game</font>\
    <table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">\
      <tr>\
        <td align="center">\
          <font class="scoreTitle">SCORE</font>\
         <font class="score">$1</font>\
       </td><td align="center">\
         <font class="scoreTitle">LINES</font>\
         <font class="score">$2</font>\
       </td><td align="center">\
         <font class="scoreTitle">LEVEL</font>\
         <font class="score">$3</font>\
       </td>\
     </tr>\
    </table>\
    <br />\
  ';
}

GameManager.prototype.update = function() {
  alert("draw update");
  var _this = this;	// Async calls change the regular "this" pointer

  if( _this.busy === 1 ) {
    return;
  }

  _this.busy = 1;

  // These variables are ready right away
  _this.scoreSubmitted = window.localStorage.getItem("scoreSubmitted");
  _this.scoreShared = window.localStorage.getItem("scoreShared");
  _this.currentScore = window.localStorage.getItem("currentScore");
  _this.currentLines = window.localStorage.getItem("currentLines");
  _this.currentLevel = window.localStorage.getItem("currentLevel");

  if( _this.currentScore !== null && (_this.todaysBest === null || _this.todaysBest < _this.currentScore) ) {
    window.localStorage.setItem("todaysBest", _this.currentScore);
  }
  _this.todaysBest = window.localStorage.getItem("todaysBest");

  // These variables require async Facebook API calls
  FB.getLoginStatus(function(response) {
    if( response.status === 'connected' ) {
      FB.api('/me/permissions?fields=publish_actions', function(response) {
        if( response.data[0]["publish_actions"] == 1 ) {
          FB.api('/me?fields=name', function(response) {
            _this.player = response;
            FB.api('/me/scores', function(response) {
              var foundPlayerScore = 0;
              for( var i = 0; i < response.data.length; i++ ) {
                if( response.data[i]["application"] != undefined && response.data[i]["application"]["id"] == "473600756038526" ) {
                  foundPlayerScore = 1;
                  break;
                }
              }
              if( foundPlayerScore === 1 ) {
                _this.playerScore = response.data[i]["score"];
                FB.api('/473600756038526/scores?fields=user,score', function(response) {
                  _this.highScores = response.data;
                  _this.highScores.sort(function(a,b) { return b["score"] - a["score"]; });
                  _this.drawUpdateFB();
                });
              }
              else {
                _this.drawUpdate();
              }
            });
          });
        }
        else {
          _this.drawUpdate();
        }
      });
    }
    else {
      _this.drawUpdate();
    }
  });
};
  
GameManager.prototype.drawUpdateFB = function() {
  alert("Draw Facebook");
  var i;

  var content = this.prepTemplate(this.templates["highscores_fb_prefix"]);

  for( i = 0; i < this.highScores.length; i++ ) {
    content += this.prepTemplate(this.templates["highscores_fb"], i+1, this.highScores[i]["user"]["id"], this.highScores[i]["user"]["name"], this.highScores[i]["score"]);
  }

  content += this.prepTemplate(this.templates["highscores_fb_postfix"]);

  if( this.playerScore !== null ) {
    content += this.prepTemplate(this.templates["yourbest"], this.player["id"], this.player["name"], this.playerScore);
  }

  this.writeElement(document.getElementById("highscores"), content);

  // All async calls have completed
  this.busy = 0;
};

GameManager.prototype.drawUpdate = function() {
  alert("Draw non-Facebook");
  var content = this.prepTemplate(this.templates["highscores_nofb"]);

  if( this.todaysBest !== null ) {
    content += this.prepTemplate(this.templates["todaysbest"], this.todaysBest);
  }

  this.writeElement(document.getElementById("highscores"), content);

alert(this.currentScore);
  if( this.currentScore !== null ) {
    content += this.prepTemplate(this.templates["lastgame"], this.currentScore, this.currentLines, this.currentLevel);
  }

  // All async calls have completed
  this.busy = 0;
};

GameManager.prototype.loginFB = function() {
  var _this = this;
  FB.login(function(response) {
    _this.update();
  }, { scope: "publish_actions" });
};

GameManager.prototype.logoutFB = function() {
  var _this = this;
  FB.logout(function(response) {
    _this.update();
  });
}

GameManager.prototype.shareFB = function(score) {
  var params = {
    method: 'feed',
    name: 'NEW HIGH SCORE',
    picture: 'http://www.anarchyarcade.com/cse/mobile/icon.png',
    caption: score
  };

  FB.ui(params, function(response) {
    this.scoreShared = 1;
    this.update();
  });
};

GameManager.prototype.prepTemplate = function(template) {
  var result = template;
  var buf, i;

  for( i = 1; i < arguments.length; i++ ) {
    while( 1 ) {
      buf = result.replace("$" + i, arguments[i]);
      if( buf !== result ) {
        result = buf;
      }
      else {
        break;
      }
    }
  }

  return result;
};

GameManager.prototype.writeElement = function(elem, content) {
  // Empty the nodes of the element
  while( elem.hasChildNodes() ){
    elem.removeChild(elem.lastChild);
  }

  // Convert our HTML into nodes
  var frag = document.createDocumentFragment();
  var temp = document.createElement('div');

  temp.innerHTML = content;	// Note that "temp" is NOT in the active DOM
  while( temp.firstChild ) {
    frag.appendChild(temp.firstChild);
  }

  // Append the new nodes to the element
  elem.appendChild(frag);
};

var gMyGameManager = new GameManager;
document.addEventListener('deviceready', function() {
  document.addEventListener("backbutton", function() { return; }, false);
  FB.init({ appId: "473600756038526", nativeInterface: CDV.FB, useCachedDialogs: false });
  gMyGameManager.update();
}, false);

</script>

</body>
</html>