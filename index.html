<!DOCTYPE html>
<html>
  <head>
    <script>
    // Module Name: scores.html
    // Elijah Newman-Gomez
    // Assignment X
    // CSE 594
    //
    // Description:
    // This page acts as the start screen and the end-game screen for Newmang Squares.
    // In either case, it will display the top scores of the user's Facebook friends.
    // It will also show the user's personal best high score.
    //
    // If there is a score in the window.localStorage key labeled "myScore", then it
    // is displayed as the last game's score.
    //
    // If the "myScore" value is higher than the user's current high score on Facebook,
    // then their high score on Facebook gets updated and the user has the option to
    // post their new high score to their Facebook wall as well.
    //
    // The bottom of this page has the main menu buttons for Newmang Squares.
    </script>

    <title>Newmang Blocks</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link href="style.css" rel="stylesheet" type="text/css" />
  </head>

<body style="background-color: #ffffff;">

  <div id="fb-root"></div>

  <div id="highscores"></div>

  <div style="position: absolute; bottom: 0; width: 100%; overflow: hidden;">
    <center>
    <a class="blueButton" href="tetris.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">New Game</span></a>
    <a class="blueButton" href="controls.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">Controls</span></a>
    <a class="blueButton" href="credits.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">Credits</span></a>
    </center>
  </div>

  <!-- cordova -->
  <script src="phonegap.js"></script>
  <!-- cordova facebook plugin -->
  <script src="cdv-plugin-fb-connect.js"></script>
  <!-- facebook js sdk -->
  <script src="facebook-js-sdk.js"></script>
        
<script>

function GameManager() {
  this.scoreSubmitted = undefined;
  this.scoreShared = undefined;
  this.todaysHighScore = undefined;
  this.currentScore = undefined;
  this.currentLines = undefined;
  this.currentLevel = undefined;

  this.player = undefined;
  this.playerScore = undefined;
  this.highScores = undefined;

  this.busy = 0;

  this.templates = new Array();
  this.templates["highscores_fb"] = '\
    High <u>score</u> template!<br />\
    Test name: $1<br />\
    Test name AGAIN: $1<br />\
  ';
}

GameManager.prototype.update = function(object) {
  if( object.busy == 1 ) {
    return;
  }

  object.busy = 1;

  // These variables are ready right away
  object.scoreSubmitted = window.localStorage.getItem("scoreSubmitted");
  object.scoreShared = window.localStorage.getItem("scoreShared");
  object.todaysHighScore = window.localStorage.getItem("todaysHighScore");
  object.currentScore = window.localStorage.getItem("currentScore");
  object.currentLines = window.localStorage.getItem("currentLines");
  object.currentLevel = window.localStorage.getItem("currentLevel");

  // These variables require async Facebook API calls
  FB.getLoginStatus(function(response) {
    if( response.status === 'connected' ) {
      FB.api('/me/permissions?fields=publish_actions', function(response) {
        if( response.data[0]["publish_actions"] == 1 ) {
          FB.api('/me?fields=name', function(response) {
            this.player = response;
            FB.api('/me/scores', function(response) {
              var foundPlayerScore = 0;
              for( var i = 0; i < response.data.length; i++ ) {
                if( response.data[i]["application"] != undefined && response.data[i]["application"]["id"] == "473600756038526" ) {
                  foundPlayerScore = 1;
                  break;
                }
              }
              if( foundPlayerScore == 1 ) {
                object.playerScore = response.data[i]["score"];
                FB.api('/473600756038526/scores?fields=user,score', function(response) {
                  object.highScores = response.data;
                  object.drawUpdateFB();
                });
              }
              else {
                object.drawUpdate();
              }
            });
          });
        }
        else {
          object.drawUpdate();
        }
      });
    }
    else {
      object.drawUpdate();
    }
  });
};
  
GameManager.prototype.drawUpdateFB = function() {
  alert("Draw Facebook");
};

GameManager.prototype.drawUpdate = function() {
  alert("Draw non-Facebook");
  var content = this.prepTemplate(this.templates["highscores_fb"], "Rumple Stiltskin");
  this.writeElement(document.getElementById("highscores"), content);
};

GameManager.prototype.loginFB = function() {
  FB.login(function(response) {
    this.update();
  }, { scope: "publish_actions" });
};

GameManager.prototype.logoutFB = function() {
  FB.logout(function(response) {
    this.update();
  });
}

GameManager.prototype.shareFB = function(score) {
  var params = {
    method: 'feed',
    name: 'NEW HIGH SCORE',
    picture: 'http://www.anarchyarcade.com/cse/mobile/icon.png',
    caption: score
  };

  FB.ui(params, function(response) {
    this.scoreShared = 1;
    this.update();
  });
};

GameManager.prototype.prepTemplate = function(template, a, b, c, d, e) {
  var result = template;
  var buf = undefined;

  if( a !== undefined ) {
    buf = undefined;
    while( buf !== result ) {
      buf = result.replace("$1", a);
    }
    result = buf;
  }

  if( b !== undefined ) {
    buf = undefined;
    while( buf !== result ) {
      buf = result.replace("$2", b);
    }
    result = buf;
  }

  if( c !== undefined ) {
    buf = undefined;
    while( buf !== result ) {
      buf = result.replace("$3", c);
    }
    result = buf;
  }

  if( d !== undefined ) {
    buf = undefined;
    while( buf !== result ) {
      buf = result.replace("$4", d);
    }
    result = buf;
  }

  if( e !== undefined ) {
    buf = undefined;
    while( buf !== result ) {
      buf = result.replace("$5", e);
    }
    result = buf;
  }

  return result;
};

GameManager.prototype.writeElement = function(elem, content) {
  // Empty the nodes of the element
  while( elem.hasChildNodes() ){
    elem.removeChild(elem.lastChild);
  }

  // Convert our HTML into nodes
  var frag = document.createDocumentFragment();
  var temp = document.createElement('div');

  temp.innerHTML = content;	// Note that "temp" is NOT in the active DOM
  while( temp.firstChild ) {
    frag.appendChild(temp.firstChild);
  }

  // Append the new nodes to the element
  elem.appendChild(frag);
};

var gMyGameManager = new GameManager;
document.addEventListener('deviceready', function() {
  document.addEventListener("backbutton", function() { return; }, false);
  FB.init({ appId: "473600756038526", nativeInterface: CDV.FB, useCachedDialogs: false });
  gMyGameManager.update(gMyGameManager);
}, false);

</script>

</body>
</html>