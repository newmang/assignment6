<!DOCTYPE html>
<html>
  <head>
    <script>
    // Module Name: scores.html
    // Elijah Newman-Gomez
    // Assignment X
    // CSE 594
    //
    // Description:
    // This page acts as the start screen and the end-game screen for Newmang Squares.
    // In either case, it will display the top scores of the user's Facebook friends.
    // It will also show the user's personal best high score.
    //
    // If there is a score in the window.localStorage key labeled "myScore", then it
    // is displayed as the last game's score.
    //
    // If the "myScore" value is higher than the user's current high score on Facebook,
    // then their high score on Facebook gets updated and the user has the option to
    // post their new high score to their Facebook wall as well.
    //
    // The bottom of this page has the main menu buttons for Newmang Squares.
    </script>

    <title>Newmang Blocks</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link href="style.css" rel="stylesheet" type="text/css" />
  </head>

<body style="background-color: #ffffff;">

  <div id="fb-root"></div>

  <div id="hs-top"></div>
  <div id="hs-middle"></div>
  <div id="hs-current"></div>

  <div style="position: absolute; bottom: 0; width: 100%; overflow: hidden;">
    <center>
    <a class="blueButton" href="tetris.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">New Game</span></a>
    <a class="blueButton" href="controls.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">Controls</span></a>
    <a class="blueButton" href="credits.html" style="width: 100%;"><span class="blueButtonText" style="font-size: 32px;">Credits</span></a>
    </center>
  </div>

  <!-- cordova -->
  <script src="phonegap.js"></script>
  <!-- cordova facebook plugin -->
  <script src="cdv-plugin-fb-connect.js"></script>
  <!-- facebook js sdk -->
  <script src="facebook-js-sdk.js"></script>
        
<script>

var scoreSubmitted = 0;
var myHighScore = 0;
function DrawHighScores(logged) {

  // Draw the Top Scores of the user's friends
  if( logged == 1 ) {
    FB.api('/473600756038526/scores', function(response) {
      response.data.sort(function(a,b) { return b["score"] - a["score"]; });

      var content = '<font class="header">Top Scores</font><a class="grayButton" href="javascript:logout();" style="float: right;"><span class="grayButtonText" style="font-size: 18px;">Logout</span></a>';
      content += '<div style="width: 100%; max-height: 162px; background-color: #ffffff; overflow-x: hidden; overflow-y: auto;">';

      for( var i = 0; i < response.data.length; i++ ) {
        content += '<table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">';
        content += '<tr>';
        content += '<td align="center" valign="middle" style="background-color: #ffffff; width: 1px;">';
        content += '<font class="label">';
        content += i+1;
        content += '</font>';
        content += '</td>';
        content += '<td style="width: 50px; margin-bottom: 0;">';
        content += '<img src="http://graph.facebook.com/';
        content += response.data[i]["user"]["id"];
        content += '/picture?type=square" style="width: 50px; display: block;" />';
        content += '</td>';
        content += '<td valign="top" width="1">';
        content += '<div style="position: relative; width: 0; height: 0;">';
        content += '<font class="name" style="position: absolute;"><nobr>';
        content += response.data[i]["user"]["name"];
        content += '</nobr></font>';
        content += '</div>';
        content += '</td>';
        content += '<td valign="bottom" align="right">';
        content += '<font class="score">';
        content += response.data[i]["score"];
        content += '</font>';
        content += '</td>';
        content += '</tr>';
        content += '</table>';
      }

      if( response.data.length == 0 ) {
        content += '<br /><font class="score">None</font>';
      }

      content += '</div>';
      content += '<br />';

      var elem = document.getElementById("hs-top");
      ClearDiv(elem);
      var fragment = CreateDOMFragment(content);
      elem.appendChild(fragment);
    });
  }
  else
  {
      var content = '<font class="header">Top Scores</font>';
      content += '<table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">';
      content += '<tr>';
      content += '<td align="center" style="font-size: 20px; font-family: arial, sans-serif;">';
      content += '<a class="greenButton" href="javascript:login();" style="float: left;"><span class="greenButtonText" style="font-size: 32px;">Login</span></a> with Facebook to access the leaderboards.';
      content += '</td>';
      content += '</tr>';
      content += '</table>';
      content += '<br />';

      var elem = document.getElementById("hs-top");
      ClearDiv(elem);
      var fragment = CreateDOMFragment(content);
      elem.appendChild(fragment);
  }

  if( logged == 1 ) {
    FB.api('/me/scores', function(response) {
      // Step through the player's scores until you find our App's
      var i = 0;
      for( ; i < response.data.length; i++ ) {
        if( response.data[i]["application"] != undefined && response.data[i]["application"]["id"] == "473600756038526" ) {
          break;
        }
      }

      if( i < response.data.length ) {
        myHighScore = response.data[i]["score"];

        var content = '<font class="header">Your Best</font>';
        content += '<table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">';
        content += '<tr>';
        content += '<td style="width: 50px; margin-bottom: 0;">';
        content += '<img src="http://graph.facebook.com/';
        content += response.data[i]["user"]["id"];
        content += '/picture?type=square" style="width: 50px; display: block;" />';
        content += '</td>';
        content += '<td valign="top" width="1">';
        content += '<div style="position: relative; width: 0; height: 0;">';
        content += '<font class="name" style="position: absolute;"><nobr>';
        content += response.data[i]["user"]["name"];
        content += '</nobr></font>';
        content += '</div>';
        content += '</td>';
        content += '<td valign="bottom" align="right">';
        content += '<font class="score">';
        content += response.data[i]["score"];
        content += '</font>';
        content += '</td>';
        content += '</tr>';
        content += '</table>';
        content += '<br />';

        var elem = document.getElementById("hs-middle");
        ClearDiv(elem);
        var fragment = CreateDOMFragment(content);
        elem.appendChild(fragment);
      }

      if( scoreSubmitted == 0 ) {
        var opts = {score: window.localStorage.getItem("score")};
        FB.api('/me/scores', 'post', opts, function(response) {
          scoreSubmitted = 1;
          DrawHighScores(1);
        });
      }
    });
  }
  else {
    if( window.localStorage.getItem("highScore") != undefined ) {
      myHighScore = window.localStorage.getItem("highScore");

      var content = '<font class="header">Today\'s Best</font>';
      content += '<table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">';
      content += '<tr>';
      content += '<td>';
      content += '<font class="score">';
      content += myHighScore;
      content += '</font>';
      content += '</td>';
      content += '</tr>';
      content += '</table>';
      content += '<br />';

      var elem = document.getElementById("hs-middle");
      ClearDiv(elem);
      var fragment = CreateDOMFragment(content);
      elem.appendChild(fragment);
    }
    else {
      var elem = document.getElementById("hs-middle");
      ClearDiv(elem);
    }
  }

  if( window.localStorage.getItem("score") != undefined ) {
    var content = '<font class="header">Last Game</font>';
    content += '<table border=0 cellspacing=0 cellpadding=0 style="border: 2px dashed #9999ff; width: 100%;">';
    content += '<tr>';
    content += '<td align="center">';
    content += '<font class="scoreTitle">SCORE</font>';
    content += '<font class="score">';
    content += window.localStorage.getItem("score");
    content += '</font>';
    content += '</td><td align="center">';
    content += '<font class="scoreTitle">LINES</font>';
    content += '<font class="score">';
    content += window.localStorage.getItem("lines");
    content += '</font>';
    content += '</td><td align="center">';
    content += '<font class="scoreTitle">LEVEL</font>';
    content += '<font class="score">';
    content += window.localStorage.getItem("level");
    content += '</font>';
    content += '</td>';
    content += '</tr>';
    content += '</table>';
    content += '<br />';

    if( window.localStorage.getItem("score") >= myHighScore ) {
      window.localStorage.setItem("highscore", myHighScore);
      content += '<center><font class="highScore">NEW HIGH SCORE!</font>';
      if( logged == 1 ) {
        content += '<br /><a class="greenButton" href="javascript:share();"><span class="greenButtonText" style="font-size: 18px;">Share on Facebook</span></a>';
      }
      content += '<center>';
    }

    var elem = document.getElementById("hs-current");
    ClearDiv(elem);
    var fragment = CreateDOMFragment(content);
    elem.appendChild(fragment);
  }
}

function login() {
  FB.login(function(response) { return; }, { scope: "publish_actions" });
}

function logout() {
  FB.logout(function(response) {
    DrawHighScores(0);
  });
}

function share() {
  var buf = 'New Person Best: ' + myHighScore;
  var params = {
    method: 'feed',
    name: 'Global Leaderboards',
    link: 'https://developers.facebook.com/docs/reference/dialogs/',
    picture: 'http://fbrell.com/f8.jpg',
    caption: 'How do you stack up?',
    description: buf
  };

  FB.ui(params, function(obj) { return; });
}

function loginResponse(response) {
  if( response.status === 'connected' ) {
    FB.api('/me/permissions', function (permissions) {
      if( permissions.data[0]["publish_actions"] === undefined ) {
        DrawHighScores(0);
      }
      else {
        DrawHighScores(1);
      } 
    });
  }
  else {
    DrawHighScores(0);
  }
}

document.addEventListener('deviceready', function() {
  FB.init({ appId: "473600756038526", nativeInterface: CDV.FB, useCachedDialogs: false });
  FB.getLoginStatus(function(response) {
    FB.Event.subscribe('auth.login', function(response) { loginResponse(response); });
    loginResponse(response);
  });
}, false);

function ClearDiv(elem){
  while( elem.hasChildNodes() ){
    elem.removeChild(elem.lastChild);
  }
}

function CreateDOMFragment(htmlStr) {
  var frag = document.createDocumentFragment();
  var temp = document.createElement('div');

  temp.innerHTML = htmlStr;
  while( temp.firstChild ) {
    frag.appendChild(temp.firstChild);
  }

  return frag;
}

</script>
</body>
</html>